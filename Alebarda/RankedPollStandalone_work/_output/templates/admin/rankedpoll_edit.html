<xf:title>
	<xf:if is="$poll.exists()">
		{{ phrase('edit_ranked_poll') }}: {$poll.title}
	<xf:else />
		{{ phrase('add_ranked_poll') }}
	</xf:if>
</xf:title>

<xf:form action="{{ link('ranked-polls/save', $poll) }}" class="block" ajax="true" id="pollEditForm">
	<div class="block-container">
		<xf:csrf />
		<h2 class="block-header">
			<xf:if is="$poll.exists()">
				{{ phrase('edit_ranked_poll') }}
			<xf:else />
				{{ phrase('add_ranked_poll') }}
			</xf:if>
		</h2>

		<div class="block-body">
			<!-- Основная информация -->
			<xf:textboxrow name="title" value="{$poll.title}" label="{{ phrase('alebarda_rankedpoll_title') }}" required="required" />

			<xf:textarearow name="description" value="{$poll.description}" label="{{ phrase('alebarda_rankedpoll_description') }}"
				hint="{{ phrase('optional') }}" rows="3"
				explain="{{ phrase('alebarda_rankedpoll_description_html_hint') }}" />

			<!-- Опции -->
			<hr class="formRowSep" />

			<xf:formrow label="{{ phrase('poll_options') }}" explain="{{ phrase('alebarda_rankedpoll_options_explain') }}">
				<div id="pollOptions">
					<xf:if is="count($poll.Options)">
						<xf:foreach loop="$poll.Options" value="$option" key="$i">
							<div class="inputGroup" data-option-index="{$i}">
								<input type="text" name="options[{$i}][text]" value="{$option.option_text}"
									class="input" placeholder="{{ phrase('option_text') }}" required />
								<span class="inputGroup-splitter"></span>
								<button type="button" class="button button--link js-removeOption">
									<i class="fa fa-times"></i>
								</button>
							</div>
						</xf:foreach>
					<xf:else />
						<div class="inputGroup" data-option-index="0">
							<input type="text" name="options[0][text]" class="input"
								placeholder="{{ phrase('option_text') }}" required />
							<span class="inputGroup-splitter"></span>
							<button type="button" class="button button--link js-removeOption">
								<i class="fa fa-times"></i>
							</button>
						</div>
						<div class="inputGroup" data-option-index="1">
							<input type="text" name="options[1][text]" class="input"
								placeholder="{{ phrase('option_text') }}" required />
							<span class="inputGroup-splitter"></span>
							<button type="button" class="button button--link js-removeOption">
								<i class="fa fa-times"></i>
							</button>
						</div>
					</xf:if>
				</div>

				<button type="button" class="button button--link js-addOption">
					<i class="fa fa-plus"></i>
					{{ phrase('add_option') }}
				</button>
			</xf:formrow>

			<!-- Статус -->
			<hr class="formRowSep" />

			<xf:formrow label="{{ phrase('alebarda_rankedpoll_winner_mode') }}">
				<xf:radio name="winner_mode" value="{$poll.winner_mode}">
					<xf:option value="single" label="{{ phrase('alebarda_rankedpoll_winner_mode_single') }}">
						<xf:hint>{{ phrase('alebarda_rankedpoll_winner_mode_single_hint') }}</xf:hint>
					</xf:option>
					<xf:option value="top_n" label="{{ phrase('alebarda_rankedpoll_winner_mode_top_n') }}">
						<xf:hint>{{ phrase('alebarda_rankedpoll_winner_mode_top_n_hint') }}</xf:hint>
					</xf:option>
					<xf:option value="seat_allocation" label="{{ phrase('alebarda_rankedpoll_winner_mode_allocation') }}">
						<xf:hint>{{ phrase('alebarda_rankedpoll_winner_mode_allocation_hint') }}</xf:hint>
					</xf:option>
				</xf:radio>
			</xf:formrow>

			<xf:formrow label="{{ phrase('alebarda_rankedpoll_winner_count') }}"
				rowclass="js-winnerCountRow"
				explain="{{ phrase('alebarda_rankedpoll_winner_count_explain') }}">
				<xf:numberbox name="winner_count" value="{$poll.winner_count}" min="1" max="100" />
			</xf:formrow>

			<hr class="formRowSep" />

			<xf:radiorow name="poll_status" value="{$poll.poll_status}" label="{{ phrase('alebarda_rankedpoll_status') }}">
				<xf:option value="draft" label="{{ phrase('draft') }}" />
				<xf:option value="open" label="{{ phrase('open') }}" />
				<xf:option value="closed" label="{{ phrase('closed') }}" />
			</xf:radiorow>

			<!-- Временные рамки -->
			<hr class="formRowSep" />

			<xf:textboxrow name="open_date"
				value="{$openDateTime}"
				type="datetime-local"
				step="60"
				label="{{ phrase('alebarda_rankedpoll_open_date') }}"
				hint="{{ phrase('alebarda_rankedpoll_open_date_hint') }}" />

			<xf:textboxrow name="close_date"
				value="{$closeDateTime}"
				type="datetime-local"
				step="60"
				label="{{ phrase('alebarda_rankedpoll_close_date') }}"
				hint="{{ phrase('alebarda_rankedpoll_close_date_hint') }}" />

			<!-- Видимость результатов -->
			<hr class="formRowSep" />

			<xf:radiorow name="results_visibility" value="{$poll.results_visibility}"
				label="{{ phrase('alebarda_rankedpoll_results_visibility') }}">
				<xf:option value="realtime" label="{{ phrase('alebarda_rankedpoll_visibility_realtime') }}"
					hint="{{ phrase('alebarda_rankedpoll_visibility_realtime_hint') }}" />
				<xf:option value="after_vote" label="{{ phrase('alebarda_rankedpoll_visibility_after_vote') }}"
					hint="{{ phrase('alebarda_rankedpoll_visibility_after_vote_hint') }}" />
				<xf:option value="after_close" label="{{ phrase('alebarda_rankedpoll_visibility_after_close') }}"
					hint="{{ phrase('alebarda_rankedpoll_visibility_after_close_hint') }}" />
				<xf:option value="never" label="{{ phrase('alebarda_rankedpoll_visibility_never') }}"
					hint="{{ phrase('alebarda_rankedpoll_visibility_never_hint') }}" />
			</xf:radiorow>

			<!-- Контроль доступа -->
			<hr class="formRowSep" />

			<xf:checkboxrow label="{{ phrase('alebarda_rankedpoll_allowed_user_groups') }}"
				explain="{{ phrase('alebarda_rankedpoll_allowed_groups_explain') }}">
				<xf:foreach loop="$userGroups" key="$groupId" value="$groupTitle">
					<xf:option name="allowed_user_groups[]" value="{$groupId}"
						label="{$groupTitle}"
						selected="{{ in_array($groupId, $allowedGroups) }}" />
				</xf:foreach>
			</xf:checkboxrow>

			<!-- Дополнительные настройки -->
			<hr class="formRowSep" />

			<xf:checkboxrow label="{{ phrase('alebarda_rankedpoll_settings') }}">
				<xf:option name="show_voter_list" value="1"
					label="{{ phrase('alebarda_rankedpoll_show_voter_list') }}"
					hint="{{ phrase('alebarda_rankedpoll_show_voter_list_hint') }}"
					selected="{$poll.show_voter_list}" />

				<xf:option name="allow_vote_change" value="1"
					label="{{ phrase('alebarda_rankedpoll_allow_vote_change') }}"
					hint="{{ phrase('alebarda_rankedpoll_allow_vote_change_hint') }}"
					selected="{$poll.allow_vote_change}" />

				<xf:option name="require_all_ranked" value="1"
					label="{{ phrase('alebarda_rankedpoll_require_all_ranked') }}"
					hint="{{ phrase('alebarda_rankedpoll_require_all_ranked_hint') }}"
					selected="{$poll.require_all_ranked}" />
			</xf:checkboxrow>

			<!-- Информация об опросе -->
			<xf:if is="$poll.exists()">
				<hr class="formRowSep" />

				<xf:formrow label="{{ phrase('alebarda_rankedpoll_poll_stats') }}">
					<dl class="pairs pairs--columns pairs--fixedSmall">
						<dt>{{ phrase('total_votes') }}:</dt>
						<dd>{$poll.voter_count}</dd>

						<dt>{{ phrase('views') }}:</dt>
						<dd>{$poll.view_count}</dd>

						<dt>{{ phrase('created') }}:</dt>
						<dd><xf:date time="{$poll.created_date}" /></dd>
					</dl>
				</xf:formrow>
			</xf:if>
		</div>

		<xf:submitrow sticky="true" icon="save" submit="{{ phrase('save') }}" />

		<xf:formrow>
			<div class="buttonGroup">
				<xf:button href="{{ link('ranked-polls') }}">
					{{ phrase('cancel') }}
				</xf:button>

				<xf:if is="$poll.exists()">
					<xf:button href="{{ link('ranked-polls/view', $poll) }}" class="button--link">
						<i class="fa fa-external-link-alt"></i>
						{{ phrase('view') }}
					</xf:button>
				</xf:if>
			</div>
		</xf:formrow>
	</div>
</xf:form>

<xf:js>
(function() {
	var optionPlaceholder = '{{ phrase('option_text')|escape('js') }}';
	var minOptionsMessage = '{{ phrase('alebarda_rankedpoll_min_two_options')|escape('js') }}';

	function getForm(target) {
		return target ? target.closest('#pollEditForm') : null;
	}

	function getOptionIndex(form) {
		var current = form.dataset.rankedPollIndex;
		if (!current) {
			current = form.querySelectorAll('#pollOptions .inputGroup').length;
			form.dataset.rankedPollIndex = current;
		}
		return parseInt(current, 10) || 0;
	}

	function addOption(form) {
		var container = form.querySelector('#pollOptions');
		var optionIndex = getOptionIndex(form);
		var wrapper = document.createElement('div');
		wrapper.className = 'inputGroup';
		wrapper.setAttribute('data-option-index', optionIndex);
		wrapper.innerHTML = ''
			+ '<input type="text" name="options[' + optionIndex + '][text]" class="input"'
			+ ' placeholder="' + optionPlaceholder + '" required />'
			+ '<span class="inputGroup-splitter"></span>'
			+ '<button type="button" class="button button--link js-removeOption">'
			+ '<i class="fa fa-times"></i>'
			+ '</button>';

		container.appendChild(wrapper);
		form.dataset.rankedPollIndex = optionIndex + 1;
	}

	function removeOption(form, button) {
		var container = form.querySelector('#pollOptions');
		var optionGroups = container.querySelectorAll('.inputGroup');

		if (optionGroups.length <= 2) {
			alert(minOptionsMessage);
			return;
		}

		var optionGroup = button.closest('.inputGroup');
		if (optionGroup) {
			optionGroup.remove();
		}
	}

	function updateWinnerCountVisibility(form) {
		var winnerCountRow = form.querySelector('.js-winnerCountRow');
		if (!winnerCountRow) {
			return;
		}

		var selected = form.querySelector('input[name="winner_mode"]:checked');
		var mode = selected ? selected.value : 'single';
		winnerCountRow.style.display = (mode === 'single') ? 'none' : '';
	}

	document.addEventListener('click', function(event) {
		var addButton = event.target.closest('.js-addOption');
		if (addButton) {
			var form = getForm(addButton);
			if (form) {
				event.preventDefault();
				addOption(form);
			}
			return;
		}

		var removeButton = event.target.closest('.js-removeOption');
		if (removeButton) {
			var form = getForm(removeButton);
			if (form) {
				event.preventDefault();
				removeOption(form, removeButton);
			}
		}
	});

	document.addEventListener('change', function(event) {
		if (event.target && event.target.name === 'winner_mode') {
			var form = getForm(event.target);
			if (form) {
				updateWinnerCountVisibility(form);
			}
		}
	});

	document.addEventListener('DOMContentLoaded', function() {
		var form = document.getElementById('pollEditForm');
		if (form) {
			updateWinnerCountVisibility(form);
		}
	});
})();
</xf:js>
