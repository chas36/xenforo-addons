# –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Ranked Poll (Schulze Method)

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢)

### ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **Setup.php**: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  - –¢–∞–±–ª–∏—Ü–∞: `xf_poll_ranked_vote` (poll_id, user_id, poll_response_id, rank_position, vote_date)
  - –ö–æ–ª–æ–Ω–∫–∏ –≤ `xf_poll`: poll_type, ranked_results_visibility, schulze_winner_cache, schulze_matrix_cache
- **Entity —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ**: `Alebarda\RankedPoll\XF\Entity\Poll`
  - –ú–µ—Ç–æ–¥: `isRankedPoll()` - —Ä–∞–±–æ—Ç–∞–µ—Ç
  - –ú–µ—Ç–æ–¥: `getUserRankedVotes($userId)` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ–ª–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ú–µ—Ç–æ–¥: `canViewRankedResults()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
- **–ö–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç**: `convert_poll_to_ranked.php` - —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ä–æ—Å—ã
- **–®–∞–±–ª–æ–Ω—ã**:
  - `poll_block_ranked.html` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å dropdown (1-15)
  - Template modification –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ ranked –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ (–ø—Ä–∏—á–∏–Ω–∞ –ø–æ–ª–æ–º–∫–∏ —Ñ–æ—Ä—É–º–∞)
- –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ (XF/Pub/Controller/Poll.php, Forum.php)
- –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤—ã–∑—ã–≤–∞—é—Ç –±–µ–ª—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø (–í–∞—Ä–∏–∞–Ω—Ç 2)

### –ü—Ä–∏–Ω—Ü–∏–ø: –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä + –Ω–æ–≤—ã–π —Ä–æ—É—Ç

```
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–ø—Ä–æ—Å—ã:
  POST /polls/vote ‚Üí XF\Pub\Controller\Poll::actionVote()

Ranked –æ–ø—Ä–æ—Å—ã:
  POST /polls/ranked-vote ‚Üí Alebarda\RankedPoll\Pub\Controller\Vote::actionVote()
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- ‚úÖ –ù–µ —Ä–∞—Å—à–∏—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
- ‚úÖ –ù–µ –ª–æ–º–∞–µ–º —Ñ–æ—Ä—É–º
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–¥

---

## –≠–¢–ê–ü 1: –ì–û–õ–û–°–û–í–ê–ù–ò–ï (Voting Interface)

### 1.1. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä Vote
**–§–∞–π–ª**: `Alebarda/RankedPoll/Pub/Controller/Vote.php`

**–ú–µ—Ç–æ–¥—ã**:
- `actionVote()`: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞
  - –ü–æ–ª—É—á–∏—Ç—å poll_id –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `$poll->canVote()`
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `$poll->isRankedPoll()`
  - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å rankings (–º–∏–Ω–∏–º—É–º 1, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ä–∞–Ω–≥–∏)
  - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `xf_poll_ranked_vote`
  - –û–±–Ω–æ–≤–∏—Ç—å voter_count –≤ `xf_poll`
  - Redirect –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø—Ä–æ—Å–∞

**–í–∞–ª–∏–¥–∞—Ü–∏—è**:
- –ú–∏–Ω–∏–º—É–º 1 –ø—Ä–æ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
- –†–∞–Ω–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏
- –†–∞–Ω–≥–∏ –æ—Ç 1 –¥–æ N (–≥–¥–µ N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)

### 1.2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç
**–§–∞–π–ª**: `Alebarda/RankedPoll/_output/routes/public/ranked_poll.json`

```json
{
    "route_type": "public",
    "route_prefix": "polls",
    "sub_name": "ranked-vote",
    "format": ":int<poll_id>",
    "build_class": "",
    "build_method": "",
    "controller": "Alebarda\\RankedPoll:Vote",
    "context": "",
    "action_prefix": ""
}
```

### 1.3. –û–±–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω poll_block_ranked.html
–ò–∑–º–µ–Ω–∏—Ç—å action —Ñ–æ—Ä–º—ã:
```html
<form action="{{ link('polls/ranked-vote', $poll) }}" method="post">
```

### 1.4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–æ—Ä—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –≤ Poll #2
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ `xf_poll_ranked_vote`

---

## –≠–¢–ê–ü 2: –ü–†–û–°–ú–û–¢–† –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (Results Display)

### 2.1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Schulze –º–µ—Ç–æ–¥
**–§–∞–π–ª**: `Alebarda/RankedPoll/Voting/Schulze.php`

**–ö–ª–∞—Å—Å**: `Schulze`

**–ú–µ—Ç–æ–¥—ã**:
- `calculateWinner(array $votes)`: –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
  - –í—Ö–æ–¥: –º–∞—Å—Å–∏–≤ –≥–æ–ª–æ—Å–æ–≤ [user_id => [response_id => rank]]
  - –í—ã—Ö–æ–¥: winner_id + –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
- `buildPairwiseMatrix($votes, $candidates)`: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ pairwise –º–∞—Ç—Ä–∏—Ü—ã
- `computeStrongestPaths($pairwise)`: Floyd-Warshall –∞–ª–≥–æ—Ä–∏—Ç–º
- `determineWinner($strongestPaths)`: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ Condorcet

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ Schulze**:
1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å pairwise comparison matrix (d[i,j] = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é—â–∏—Ö i –ø–µ—Ä–µ–¥ j)
2. –í—ã—á–∏—Å–ª–∏—Ç—å strongest paths (p[i,j] = —Å–∏–ª–∞ —Å–∞–º–æ–≥–æ —Å–∏–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ –æ—Ç i –∫ j)
3. i –ø–æ–±–µ–∂–¥–∞–µ—Ç j –µ—Å–ª–∏ p[i,j] > p[j,i]
4. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å = –∫–∞–Ω–¥–∏–¥–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–±–µ–∂–¥–∞–µ—Ç –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

### 2.2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ Entity Poll
**–§–∞–π–ª**: `Alebarda/RankedPoll/XF/Entity/Poll.php`

```php
public function calculateRankedResults()
{
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–∞
    $votes = $this->db()->fetchAll("
        SELECT user_id, poll_response_id, rank_position
        FROM xf_poll_ranked_vote
        WHERE poll_id = ?
        ORDER BY user_id, rank_position
    ", $this->poll_id);

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Schulze
    $formattedVotes = [];
    foreach ($votes as $vote) {
        $formattedVotes[$vote['user_id']][$vote['poll_response_id']] = $vote['rank_position'];
    }

    // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º
    $schulze = new \Alebarda\RankedPoll\Voting\Schulze();
    $result = $schulze->calculateWinner($formattedVotes);

    // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    $this->schulze_winner_cache = $result['winner_id'];
    $this->schulze_matrix_cache = json_encode($result['matrix']);
    $this->save();

    return $result;
}
```

### 2.3. –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–§–∞–π–ª**: `Alebarda/RankedPoll/_output/templates/public/poll_results_ranked.html`

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**:
- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å (—Å –∏–∫–æ–Ω–∫–æ–π üèÜ)
- Pairwise comparison matrix (—Ç–∞–±–ª–∏—Ü–∞)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É:
  - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±—ã–ª –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ #1
  - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±—ã–ª –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ #2
  - –°—Ä–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è
- –î–µ—Ç–∞–ª–∏ —Å–∏–ª—å–Ω–µ–π—à–∏—Ö –ø—É—Ç–µ–π (–¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è)

### 2.4. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–§–∞–π–ª**: `Alebarda/RankedPoll/Pub/Controller/Vote.php`

```php
public function actionResults(ParameterBag $params)
{
    $poll = $this->assertViewablePoll($params->poll_id);

    if (!$poll->isRankedPoll()) {
        return $this->redirect($this->buildLink('polls', $poll));
    }

    if (!$poll->canViewRankedResults()) {
        return $this->noPermission();
    }

    $results = $poll->calculateRankedResults();

    return $this->view('Alebarda\RankedPoll:Results', 'poll_results_ranked', [
        'poll' => $poll,
        'results' => $results
    ]);
}
```

### 2.5. –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```json
{
    "route_prefix": "polls",
    "sub_name": "ranked-results",
    "format": ":int<poll_id>",
    "controller": "Alebarda\\RankedPoll:Vote",
    "action_prefix": "results"
}
```

### 2.6. –û–±–Ω–æ–≤–∏—Ç—å poll_block_ranked.html
–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" –µ—Å–ª–∏ `$poll->canViewRankedResults()`

---

## –≠–¢–ê–ü 3: –°–û–ó–î–ê–ù–ò–ï RANKED –û–ü–†–û–°–û–í (Poll Creation UI)

### –ü–æ–¥—Ö–æ–¥: Template Modification –≤ editor

### 3.1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–∞ helper_poll_edit
**–§–∞–π–ª**: `_output/template_modifications/public/poll_edit_add_ranked_option.json`

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å checkbox "Ranked-choice voting (Schulze method)" –≤ —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø—Ä–æ—Å–∞

**–ú–µ—Å—Ç–æ –≤—Å—Ç–∞–≤–∫–∏**: –ü–æ—Å–ª–µ –ø–æ–ª—è "Maximum selectable responses" –∏–ª–∏ "Change vote"

```html
<xf:checkboxrow>
    <xf:option name="poll[poll_type]" value="ranked"
               label="Enable ranked-choice voting (Schulze method)"
               hint="Users will rank options instead of selecting them" />
</xf:checkboxrow>
```

### 3.2. –°–æ–∑–¥–∞—Ç—å Listener –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
**–ù–ï–¢! Listeners –ª–æ–º–∞–ª–∏ —Ñ–æ—Ä—É–º —Ä–∞–Ω–µ–µ**

### 3.3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Service —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
**–§–∞–π–ª**: `Alebarda/RankedPoll/XF/Service/Poll/Editor.php`

**–í–ù–ò–ú–ê–ù–ò–ï**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Service —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã (–Ω–µ –ª–æ–º–∞—é—Ç —Ñ–æ—Ä—É–º –∫–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã)

```php
protected function _save()
{
    $pollType = $this->request->filter('poll.poll_type', 'str');
    if ($pollType === 'ranked') {
        $this->poll->poll_type = 'ranked';
        $this->poll->ranked_results_visibility = 'after_close'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    return parent::_save();
}
```

### 3.4. –ï—Å–ª–∏ Service –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É
**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω**:
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É "Convert poll to ranked"
- –ê–¥–º–∏–Ω—ã –≤—Ä—É—á–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç –æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ–æ—Ä–º—É
- –ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CLI —Å–∫—Ä–∏–ø—Ç

---

## –≠–¢–ê–ü 4: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ì–û–õ–û–°–û–í (Vote Editing)

### 4.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
```php
public function actionVote()
{
    // ...

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ—Å
    if ($poll->hasVoted() && !$poll->change_vote) {
        return $this->error('–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ—Å.');
    }

    // –ï—Å–ª–∏ change_vote = true, —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≥–æ–ª–æ—Å–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö
    // (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ saveRankedVotes)
}
```

### 4.2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –≥–æ–ª–æ—Å–æ–≤
–í `poll_block_ranked.html` —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `$userRankedVotes` –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è dropdown

–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –º–µ—Ç–æ–¥ `getUserRankedVotes()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```php
public function getUserRankedVotes($userId = null)
{
    $userId = $userId ?: \XF::visitor()->user_id;

    $votes = $this->db()->fetchPairs("
        SELECT poll_response_id, rank_position
        FROM xf_poll_ranked_vote
        WHERE poll_id = ? AND user_id = ?
    ", [$this->poll_id, $userId]);

    return $votes;
}
```

---

## –≠–¢–ê–ü 5: –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–ü–¶–ò–ò

### 5.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–û–ø—Ü–∏–∏** (—É–∂–µ –≤ –ë–î –∫–∞–∫ `ranked_results_visibility`):
- `always`: –í—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã
- `after_vote`: –ü–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
- `after_close`: –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–ø—Ä–æ—Å–∞
- `never`: –ù–∏–∫–æ–≥–¥–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)

### 5.2. UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
–î–æ–±–∞–≤–∏—Ç—å –≤ template modification poll_edit:
```html
<xf:if is="$poll.poll_type == 'ranked'">
    <xf:radiorow name="poll[ranked_results_visibility]" value="{$poll.ranked_results_visibility}">
        <xf:option value="always" label="Always visible" />
        <xf:option value="after_vote" label="Visible after voting" />
        <xf:option value="after_close" label="Visible after poll closes" selected="true" />
        <xf:option value="never" label="Never visible (admins only)" />
    </xf:radiorow>
</xf:if>
```

---

## –≠–¢–ê–ü 6: –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò

### 6.1. –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–§–∞–π–ª**: `Pub/Controller/Vote.php`

```php
public function actionExport(ParameterBag $params)
{
    $poll = $this->assertViewablePoll($params->poll_id);

    // CSV —ç–∫—Å–ø–æ—Ä—Ç –º–∞—Ç—Ä–∏—Ü—ã
    $results = $poll->calculateRankedResults();

    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å CSV
    return $this->csvResponse(...);
}
```

### 6.2. –ò—Å—Ç–æ—Ä–∏—è –≥–æ–ª–æ—Å–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
–ü–æ–∫–∞–∑–∞—Ç—å –∫—Ç–æ –∫–∞–∫ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)

### 6.3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
–£–≤–µ–¥–æ–º–∏—Ç—å –∞–≤—Ç–æ—Ä–∞ –æ–ø—Ä–æ—Å–∞ –∫–æ–≥–¥–∞ –æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã

---

## –ü–û–†–Ø–î–û–ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–∞–∑–∞ 1: MVP (–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–¥—É–∫—Ç)
**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å, —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. ‚úÖ Setup.php (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
2. ‚úÖ Entity Poll (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
3. ‚úÖ poll_block_ranked.html (—É–∂–µ —Å–æ–∑–¥–∞–Ω)
4. **TODO**: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä Vote + —Ä–æ—É—Ç
5. **TODO**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Schulze –∞–ª–≥–æ—Ä–∏—Ç–º–∞
6. **TODO**: –®–∞–±–ª–æ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
7. **TODO**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Poll #2

### –§–∞–∑–∞ 2: –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
**–¶–µ–ª—å**: UI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ranked –æ–ø—Ä–æ—Å–æ–≤

8. **TODO**: Template modification –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
9. **TODO**: Service —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
10. **TODO**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏—è
**–¶–µ–ª—å**: UX, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏

11. **TODO**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
12. **TODO**: –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
13. **TODO**: –£–ª—É—á—à–µ–Ω–Ω—ã–π UI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≥—Ä–∞—Ñ–∏–∫–∏?)
14. **TODO**: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø

### –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PHP —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ: `php -l file.php`
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å namespace –∏ use statements
3. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —á–µ—Ä–µ–∑ XFCP
4. ‚úÖ Commit –≤ git (–ª–æ–∫–∞–ª—å–Ω–æ)

### –ó–∞–≥—Ä—É–∑–∫–∞:
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP
2. –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç (curl)
4. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: `xf-dev:import-*`
5. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä—É–º —Å–Ω–æ–≤–∞
7. –ï—Å–ª–∏ –±–µ–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç—å, —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã

### –û—Ç–∫–∞—Ç:
1. –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã
2. –û—á–∏—Å—Ç–∏—Ç—å code_cache
3. Rebuild caches
4. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞

---

## –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø

### –†–∏—Å–∫ 1: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä Vote —Ç–æ–∂–µ —Å–ª–æ–º–∞–µ—Ç —Ñ–æ—Ä—É–º
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –≠—Ç–æ –ù–ï —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –∞ standalone –∫–ª–∞—Å—Å
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –ë–ï–ó —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–∞ —Å–Ω–∞—á–∞–ª–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–æ—Ä—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç

### –†–∏—Å–∫ 2: Service —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–ª–æ–º–∞–µ—Ç —Ñ–æ—Ä—É–º
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –û—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ –§–∞–∑—É 2
- –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Service –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

### –†–∏—Å–∫ 3: Schulze –∞–ª–≥–æ—Ä–∏—Ç–º –º–µ–¥–ª–µ–Ω–Ω—ã–π
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `schulze_winner_cache`
- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –≥–æ–ª–æ—Å–∞—Ö
- –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–ø—Ä–æ—Å–æ–≤ (>100 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### –†–∏—Å–∫ 4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–Ω–∏–º–∞—é—Ç ranked voting
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ poll_block_ranked
- –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞
- –ü—Ä–∏–º–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è

---

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì

**–°–ï–ô–ß–ê–°**: –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1, —à–∞–≥ 4

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `Pub/Controller/Vote.php` –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å.

–ü–æ—Å–ª–µ –≤–∞—à–µ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è - –∑–∞–≥—Ä—É–∂—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É—é.
